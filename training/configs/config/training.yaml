# YOLOv8 训练配置
# ⚠️ 重要：相对路径相对于 /training/configs 目录
# 本配置适配 train_classify.py (YOLOv8 分类训练脚本)

training:
  # 训练轮数
  epochs: 200

  # 批次大小
  batch_size: 16

  # 图片尺寸
  image_size: 640

  # 数据加载线程数
  workers: 8

  # 混合精度训练
  amp: true

  # 最小样本数（低于此数量的机型类别将被过滤）
  min_samples_per_class: 8

  # 高级训练功能
  advanced:
    # 梯度累计（有效batch size = batch_size * accumulate）
    accumulate: 1

    # Confidence Penalty（防止过自信）
    confidence_penalty: 0.0

    # Focal Loss（解决类别不平衡）
    focal_loss:
      enabled: true
      alpha: 0.25
      gamma: 4.0

    # ElasticFace Loss（基于动态 margin 的角度损失）
    elastic_face:
      enabled: false
      type: "cos+"       # ElasticFace 类型: cos, arc, cos+, arc+ (CosFace, ArcFace, CosFace+, ArcFace+)
      lambda_weight: 0.5  # ElasticFace loss 权重 (total = CE + lambda * ElasticFace)
      s: 30.0            # 缩放因子 (YOLO-adapted, 原论文推荐 64.0)
      m: 0.30            # 基础 margin (YOLO-adapted, 原论文推荐 0.50)
      std: 0.01          # margin 采样标准差 (YOLO-adapted, 原论文推荐 0.0125)
      plus: true        # 是否启用 ElasticArcFace+ (自适应 margin)

  # ========================================
  # YOLOv8 原生数据增强参数
  # ========================================
  augmentation:
    # HSV 色彩增强（光照变化鲁棒性）
    hsv:
      h: 0.015      # Hue 变化范围 (0.0-1.0)
      s: 0.7        # Saturation 变化范围 (0.0-1.0)
      v: 0.4        # Value (亮度) 变化范围 (0.0-1.0)

    # 几何变换
    degrees: 0.0       # 旋转角度范围 (+/- degrees)
    translate: 0.1     # 平移比例 (0.0-1.0)
    scale: 0.5         # 缩放增益 (0.0-1.0, e.g. 0.5 = 50%-150%)
    shear: 0.0         # 剪切角度 (+/- degrees)
    perspective: 0.0   # 透视变换因子 (0.0-0.001)

    # 翻转
    flipud: 0.0        # 垂直翻转概率 (0.0-1.0)
    fliplr: 0.5        # 水平翻转概率 (0.0-1.0)
    bgr: 0.0           # RGB↔BGR 通道交换概率 (0.0-1.0)

    # 复合增强
    mosaic: 1.0        # Mosaic 增强概率 (0.0-1.0)
    mixup: 0.0         # MixUp 增强概率 (0.0-1.0) ⚠️ 注意：这是 YOLO 原生的 mixup 参数
    cutmix: 0.0        # CutMix 增强概率 (0.0-1.0)
    copy_paste: 0.0    # Copy-Paste 增强概率 (仅检测任务, 0.0-1.0)
    copy_paste_mode: flip # Copy-Paste 模式: flip 或 mixup

    # Mosaic 控制
    close_mosaic: 10   # 关闭 Mosaic 的 epoch 数 (0=保持开启)

    # Mosaic 边界
    border: [0, 0]     # Mosaic 边界大小 (y, x)

  # ========================================
  # 其他训练策略
  # ========================================
  training_strategies:
    # 多尺度训练
    multi_scale: 0.0    # 多尺度范围 (0.0=禁用, 0.0-1.0)

    # 矩形批次（仅检测任务）
    rect: false         # 矩形批次 (false=方形批次)

    # 数据集使用比例
    fraction: 1.0      # 使用训练数据集的比例 (1.0=全部)

    # 性能分析
    profile: false      # profile ONNX/TensorRT 速度 (false=禁用)

    # torch.compile() 优化
    compile: false       # 启用 torch.compile() (false=禁用)

    # 单类别训练
    single_cls: false   # 将所有类别视为单个类别

    # 冻结层数
    freeze: null        # 冻结前 N 层或特定层索引列表

    # 自动增强策略（仅分类任务）
    auto_augment: randaugment  # 自动增强: randaugment, autoaugment, augmix

    # 随机擦除（仅分类任务）
    erasing: 0.4        # 随机擦除概率 (0.0-1.0)

    # 缓存图像
    cache: false        # 缓存图像: false, true(ram), 'disk'

    # 确定性操作
    deterministic: true # 启用确定性操作 (可复现但可能较慢)

  # 模型配置
  model:
    # YOLOv8 预训练模型名称或路径
    name: "yolo26x-cls.pt"

  # 优化器配置
  optimizer:
    # 优化器类型: SGD, Adam, AdamW, NAdam, RAdam, RMSProp, auto
    type: "AdamW"

    # 初始学习率
    lr0: 0.001

    # SGD动量 或 Adam beta1
    momentum: 0.937

    # 权重衰减 (L2正则化)
    weight_decay: 0.0005

  # 学习率调度器
  scheduler:
    # 是否使用余弦学习率调度
    cosine: true

    # 最终学习率衰减比例 (final_lr = lr0 * lrf)
    lrf: 0.01

    # Warmup 初始动量
    warmup_momentum: 0.8

    # Warmup 期间的 bias 学习率
    warmup_bias_lr: 0.1

  # 正则化
  regularization:
    # 分类头的Dropout
    dropout: 0.0

  # 早停
  early_stopping:
    # 耐心值（多少个epoch没有改善就停止）
    patience: 50

  # Warmup配置
  warmup:
    # Warmup轮数
    epochs: 3.0

  # 输出配置
  output:
    # 项目根目录（YOLO训练结果保存位置）
    project: "../output/classify"

    # 实验名称
    name: "aircraft_classifier"

  # 保存周期（每N个epoch保存一次检查点，-1禁用）
  save_period: -1

  # 验证配置
  validation:
    # 是否启用验证
    enabled: true

  # 是否保存训练可视化图表
  plots: true

# ========================================
# 高级配置（用于自定义PyTorch训练）
# ========================================

# 多任务学习（Stage 3+）
multitask:
  # 是否启用多任务
  enabled: false

  # 任务权重
  task_weights:
    type_classification: 1.0
    airline_classification: 1.0
    quality_regression: 1.0

  # 损失函数权重策略: fixed, uncertainty, dwa
  loss_weight_strategy: "uncertainty"

# 自定义模型配置（非YOLOv8）
custom_model:
  # backbone类型: convnext, swin, resnet
  backbone: "convnext"

  # ConvNeXt配置
  convnext:
    model_name: "convnext_base"  # tiny, small, base, large
    pretrained: true
    drop_path_rate: 0.1

  # Swin Transformer配置
  swin:
    model_name: "swin_base_patch4_window7_224"
    pretrained: true
    drop_path_rate: 0.1

  # 分类头配置
  classifier:
    hidden_dim: 512
    dropout: 0.1
    num_layers: 2

# Stage特定配置
stage_configs:
  # Stage 2: 单模型单任务（机型分类）
  stage2:
    num_classes: null  # 从数据集自动推断
    loss: "cross_entropy"

  # Stage 3: 单模型多Head（机型+航司）
  stage3:
    num_type_classes: null
    num_airline_classes: null
    shared_backbone: true

  # Stage 4: 加清晰度Head
  stage4:
    quality_head: true
    quality_loss: "mse"

  # Stage 5: 模型杂交（ConvNeXt + Swin）
  stage5:
    use_ensemble: true
    ensemble_method: "weighted_avg"  # weighted_avg, voting, stacking
    model_weights: [0.5, 0.5]

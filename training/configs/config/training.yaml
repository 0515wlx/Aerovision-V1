# YOLOv8 训练配置
# ⚠️ 重要：相对路径相对于 /training/configs 目录
# 本配置适配 train_classify.py (YOLOv8 分类训练脚本)

training:
  # 训练轮数
  epochs: 200

  # 批次大小
  batch_size: 16

  # 图片尺寸
  image_size: 640

  # 数据加载线程数
  workers: 8

  # 混合精度训练
  amp: true

  # 最小样本数（低于此数量的机型类别将被过滤）
  min_samples_per_class: 8

  # 高级训练功能
  advanced:
    # 梯度累计（有效batch size = batch_size * accumulate）
    accumulate: 1

    # Confidence Penalty（防止过自信）
    confidence_penalty: 0.0

    # Focal Loss（解决类别不平衡）
    focal_loss:
      enabled: false
      alpha: 0.25
      gamma: 2.0

    # Mixup 数据增强
    mixup:
      enabled: false
      alpha: 0.2

    # ElasticFace Loss（基于动态 margin 的角度损失）
    elastic_face:
      enabled: false
      type: "cos+"       # ElasticFace 类型: cos, arc, cos+, arc+ (CosFace, ArcFace, CosFace+, ArcFace+)
      lambda_weight: 0.5  # ElasticFace loss 权重 (total = CE + lambda * ElasticFace)
      s: 30.0            # 缩放因子 (YOLO-adapted, 原论文推荐 64.0)
      m: 0.30            # 基础 margin (YOLO-adapted, 原论文推荐 0.50)
      std: 0.01          # margin 采样标准差 (YOLO-adapted, 原论文推荐 0.0125)
      plus: true        # 是否启用 ElasticArcFace+ (自适应 margin)

  # 模型配置
  model:
    # YOLOv8 预训练模型名称或路径
    name: "yolo26x-cls.pt"

  # 优化器配置
  optimizer:
    # 优化器类型: SGD, Adam, AdamW, NAdam, RAdam, RMSProp, auto
    type: "AdamW"

    # 初始学习率
    lr0: 0.001

    # SGD动量 或 Adam beta1
    momentum: 0.937

    # 权重衰减 (L2正则化)
    weight_decay: 0.0005

  # 学习率调度器
  scheduler:
    # 是否使用余弦学习率调度
    cosine: true

    # 最终学习率衰减比例 (final_lr = lr0 * lrf)
    lrf: 0.01

  # 正则化
  regularization:
    # 分类头的Dropout
    dropout: 0.0

  # 早停
  early_stopping:
    # 耐心值（多少个epoch没有改善就停止）
    patience: 50

  # Warmup配置
  warmup:
    # Warmup轮数
    epochs: 3.0

  # 输出配置
  output:
    # 项目根目录（YOLO训练结果保存位置）
    project: "../output/classify"

    # 实验名称
    name: "aircraft_classifier"

  # 保存周期（每N个epoch保存一次检查点，-1禁用）
  save_period: -1

  # 验证配置
  validation:
    # 是否启用验证
    enabled: true

  # 是否保存训练可视化图表
  plots: true

# ========================================
# 高级配置（用于自定义PyTorch训练）
# ========================================

# 多任务学习（Stage 3+）
multitask:
  # 是否启用多任务
  enabled: false

  # 任务权重
  task_weights:
    type_classification: 1.0
    airline_classification: 1.0
    quality_regression: 1.0

  # 损失函数权重策略: fixed, uncertainty, dwa
  loss_weight_strategy: "uncertainty"

# 自定义模型配置（非YOLOv8）
custom_model:
  # backbone类型: convnext, swin, resnet
  backbone: "convnext"

  # ConvNeXt配置
  convnext:
    model_name: "convnext_base"  # tiny, small, base, large
    pretrained: true
    drop_path_rate: 0.1

  # Swin Transformer配置
  swin:
    model_name: "swin_base_patch4_window7_224"
    pretrained: true
    drop_path_rate: 0.1

  # 分类头配置
  classifier:
    hidden_dim: 512
    dropout: 0.1
    num_layers: 2

# Stage特定配置
stage_configs:
  # Stage 2: 单模型单任务（机型分类）
  stage2:
    num_classes: null  # 从数据集自动推断
    loss: "cross_entropy"

  # Stage 3: 单模型多Head（机型+航司）
  stage3:
    num_type_classes: null
    num_airline_classes: null
    shared_backbone: true

  # Stage 4: 加清晰度Head
  stage4:
    quality_head: true
    quality_loss: "mse"

  # Stage 5: 模型杂交（ConvNeXt + Swin）
  stage5:
    use_ensemble: true
    ensemble_method: "weighted_avg"  # weighted_avg, voting, stacking
    model_weights: [0.5, 0.5]
